/*! pePlayer 21-11-2014 */
function getGlobalContainer(){var a;return"undefined"!=typeof module?a=module:"undefined"!=typeof window&&(window.exports=window.exports||{},a=window),a}!function(a){var b={};b.test={},a.exports=function(a,c){"use strict";function d(a,b){var c=new XMLHttpRequest;c.onload=function(){var d,e;return 200===c.status?(d=JSON.parse(c.responseText),a(d),void((0!==d.readingList.length||0!==d.authorList)&&(q.log(q.LEVEL.DEVELOPMENT,"User Reading List: "+d.readingList),q.log(q.LEVEL.DEVELOPMENT,"User Author List: "+d.authorList),e=d.readingList.concat(d.authorList),b(e)))):void o("getAuthorInformation: Getting author data failed with error code: "+c.status,!0)},c.open("GET","/peAPI/user/self"),c.send(null)}function e(a){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4===b.readyState)if(200===b.status){var a=JSON.parse(b.responseText);q.log(q.LEVEL.DEBUG,"Successful Author Update."+a)}else q.log(q.LEVEL.PRODUCTION,"Error:  Author Update failed")},b.open("PUT","/peAPI/user/"+a._id),b.setRequestHeader("Content-Type","application/json"),b.send(JSON.stringify(a))}function f(a){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4===b.readyState)if(200===b.status){var a=JSON.parse(b.responseText);q.log(q.LEVEL.DEBUG,"Chapter successfully marked as completed. "+a)}else q.log(q.LEVEL.PRODUCTION,"Error:  Marking chapter complete failed. ")},b.open("PUT","/peAPI/session/complete/chapter/"+a),b.setRequestHeader("Content-Type","text/plain"),b.send(a)}function g(a){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4===b.readyState)if(200===b.status){var a=JSON.parse(b.responseText);q.log(q.LEVEL.DEBUG,"Event successfully marked as completed. "+a)}else q.log(q.LEVEL.PRODUCTION,"Error:  Marking event complete failed. ")},b.open("PUT","/peAPI/session/complete/event/"+a),b.setRequestHeader("Content-Type","text/plain"),b.send(a)}function h(a,b){var c=[];c.push(a),b(c)}function i(b,c){var d=new XMLHttpRequest;d.onload=function(){var e;200===d.status?(e=JSON.parse(d.responseText),a.addStory(e),n(e),i(b,c)):404===d.status?(q.log(q.LEVEL.DEBUG,"Skipping Story..."),i(b,c)):o("getAllStories: Error retrieving user stories.",!0)},c.length>0?(d.open("GET","/peAPI/story/"+c.pop()),d.send(null)):(q.log(q.LEVEL.PRODUCTION,"pePS.getAllStories: Stories all done."),b(a.getAllChapters()))}function j(a){var b=new XMLHttpRequest;b.onload=function(){var c;200===b.status?(c=JSON.parse(b.responseText),c&&a(c)):q.log(q.LEVEL.PRODUCTION,"Error retrieving user stories.")},b.open("GET","/peAPI/story/recent"),b.send(null)}function k(a,b){var c=new XMLHttpRequest;c.onload=function(){var a;200===c.status?(a=JSON.parse(c.responseText),a&&b(a)):q.log(q.LEVEL.PRODUCTION,"Error retrieving stories by keyword.")},c.open("GET","/peAPI/story/keyword/"+a),c.send(null)}function l(b,c){var d=new XMLHttpRequest;q.log(q.LEVEL.DEBUG,"getAllChapters: chapterList = "+c),d.onload=function(){var e;200===d.status?(e=JSON.parse(d.responseText),e.found=!1,a.addChapter(e),q.log(q.LEVEL.DEBUG,"Just got the chapter: "+JSON.stringify(e)),l(b,c)):404===d.status?(q.log(q.LEVEL.DEBUG,"Skipping Chapter..."),l(b,c)):o("getAllChapters: Error retrieving user chapters.",!0)},c.length>0?(d.open("GET","/peAPI/chapter/"+c.pop()),d.send(null)):(q.log(q.LEVEL.PRODUCTION,"pePS.getAllChapters: Chapters all done."),b(a.getAllEvents()))}function m(b,c){var d=new XMLHttpRequest;d.onload=function(){var e;200===d.status?(e=JSON.parse(d.responseText),e.found=!1,a.addEvent(e),m(b,c)):404===d.status?(q.log(q.LEVEL.DEBUG,"Skipping Event..."),m(b,c)):o("getAllEvents: Error retrieving user events.",!0)},c.length>0?(d.open("GET","/peAPI/event/"+c.pop()),d.send(null)):(q.log(q.LEVEL.PRODUCTION,"pePS.getAllEvents: Events all done."),b())}function n(a){var b=new Image;a&&a.image&&(b.src=a.image)}function o(a,b){q.log(q.LEVEL.PRODUCTION,a),b&&p()}function p(){q.log(q.LEVEL.DEVELOPMENT,"STOP SPINNER"),$.mobile.loading("hide")}var q=c.mhLog;return b.checkAuth=function(a){var b=new XMLHttpRequest;b.onload=function(){if(200===b.status){var c=JSON.parse(b.responseText);return q.log(q.LEVEL.DEVELOPMENT,"checkAuth: "+JSON.stringify(c)),void a(c)}q.log(q.LEVEL.PRODUCTION,"Checking user authorization failed with error code: "+b.status)},b.open("GET","/peAPI/user/checkAuth"),b.send(null)},b.updateAuthor=function(a){e(a)},b.getAuthorData=function(a,b){d(a,i.bind(void 0,l.bind(void 0,m.bind(void 0,b))))},b.markChapterCompleted=function(a){q.log(q.LEVEL.DEVELOPMENT,"In pePlayerServer.markChapterCompleted "+a._id),f(a._id)},b.markEventCompleted=function(a){q.log(q.LEVEL.DEVELOPMENT,"In pePlayerServer.markEventCompleted "+a._id),g(a._id)},b.getRecentStories=function(a){j(a)},b.keywordSearch=function(a,b){a&&k(a,b)},b.getStory=function(a,b){h(a,i.bind(void 0,l.bind(void 0,m.bind(void 0,b))))},b}}(getGlobalContainer());