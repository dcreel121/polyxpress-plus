/*! pePlayer 21-11-2014 */
function getGlobalContainer(){var a;return"undefined"!=typeof module?a=module:"undefined"!=typeof window&&(window.exports=window.exports||{},a=window),a}!function(a){var b;b={},b.test={},a.exports=function(a){"use strict";function c(a){v=a,z.log(z.LEVEL.DEBUG,"In setAuthorData: "+JSON.stringify(v)),$.mobile.changePage("#mainView")}function d(){var a,b,c;for(b=document.getElementById("storyList"),u(b),c=document.getElementById("authorStoryList"),u(c),a=0;a<A.storyMap.length;a++)e(A.storyMap[a],b,c,v.readingList,v.authorList);s(),$("#storyList").hasClass("ui-listview")&&$("#storyList").listview("refresh"),$("#authorStoryList").hasClass("ui-listview")&&$("#authorStoryList").listview("refresh")}function e(a,c,d,e,g){var h,i,j,k,l;if(h=document.createElement("li"),i=document.createElement("a"),i.href="#overviewStory",a.image){var m=document.createElement("img");m.onload=s,m.src=a.image,i.appendChild(m)}k=document.createElement("h4"),k.innerHTML=a.title,i.appendChild(k),l=document.createElement("p"),l.innerHTML=a.overview,i.appendChild(l),h.appendChild(i),h.setAttribute("data-theme","c"),e.indexOf(a._id)>=0?(h.onclick=t(a._id,b.showStoryOverview),j=document.createElement("a"),j.href="#editStory",j.setAttribute("data-rel","popup"),j.setAttribute("data-position-to","window"),j.setAttribute("data-transition","pop"),j.onclick=t(a._id,f),j.innerHTML="Edit Story",h.appendChild(j),c.appendChild(h)):g.indexOf(a._id)>=0&&(a.test&&(k.innerHTML="<i>(Test)</i> "+k.innerHTML,h.setAttribute("data-theme","b")),h.onclick=t(a._id,b.showStoryOverview),d.appendChild(h))}function f(a){var b;z.log(z.LEVEL.DEBUG,"showEditStoryPopup: id = "+a),b=document.getElementById("removeStoryButton"),b.onclick=g.bind(this,a)}function g(a){z.log(z.LEVEL.DEBUG,"removeStoryFromReadingList: story id = "+a),v.readingList.splice(v.readingList.indexOf(a),1),A.removeStory(a),B.updateAuthor(v),d()}function h(a){var b,c,d;for(c=document.getElementById("recentStories"),u(c),b=0;b<a.length;b++)v.readingList.indexOf(a[b]._id)>=0||(d=document.createElement("li"),d.innerHTML="<a href='#addLibraryStory' data-rel='popup' data-position-to='window' data-transition='pop'>"+a[b].title+"</a>",d.onclick=t({id:a[b]._id,li:d,ul:c},i),c.appendChild(d));s(),$("#recentStories").hasClass("ui-listview")&&$("#recentStories").listview("refresh")}function i(a){var b;b=document.getElementById("addLibraryStoryButton"),b.onclick=j.bind(this,a)}function j(a){var c=a.id;return a.ul.removeChild(a.li),v.readingList.indexOf(c)>=0?void z.log(z.LEVEL.DEVELOPMENT,"addRecentStory: Story("+c+") already in reading List"):(v.readingList.push(c),B.updateAuthor(v),B.getStory(c,d),void b.showLibraryView())}function k(a){var b,c,d;for(c=document.getElementById("keywordStories"),u(c),b=0;b<a.length;b++)v.readingList.indexOf(a[b]._id)>=0?z.log(z.LEVEL.DEVELOPMENT,"populateKeywordSearchList:  Already in reading List"):(d=document.createElement("li"),d.innerHTML="<a href='#addLibraryStory' data-rel='popup' data-position-to='window' data-transition='pop'>"+a[b].title+"</a>",d.onclick=t({id:a[b]._id,li:d,ul:c},i),c.appendChild(d));s(),$("#keywordStories").hasClass("ui-listview")&&$("#keywordStories").listview("refresh")}function l(a,c,d){var e,f=A.findChapterByID(d);f&&(f.completed!==!0?C.chapterInRange(f)?(f.found===!1&&(D=!0),f.found=!0,e=document.createElement("li"),e.innerHTML="<a href='#overviewChapter'>"+f.title+"</a>",e.onclick=t(f._id,b.showChapterOverview),a.appendChild(e),m(f)):(f.found=!1,e=document.createElement("li"),e.innerHTML="<a href=''>"+f.title+"<br><span class='distance'>("+C.getDistanceFromChapter(f)+" km)</span> </a>",e.setAttribute("class","inactive"),a.appendChild(e)):(e=document.createElement("li"),e.innerHTML="<a href='#overviewChapter'>"+f.title+"</a>",e.onclick=t(f._id,b.showChapterOverview),c.appendChild(e),m(f)))}function m(a){var b;a.image&&(b=new Image,b.src=a.image)}function n(a,c,d){var e,f=A.findEventByID(d);f&&(f.completed!==!0?C.eventInRange(f)?(f.found===!1&&(E=!0),f.found=!0,e=document.createElement("li"),e.innerHTML="<a href='#scrapbookView'>"+f.title+"</a>",e.onclick=t(f._id,b.showScrapbookView),a.appendChild(e),o(f)):(f.found=!1,e=document.createElement("li"),e.innerHTML="<a href=''>"+f.title+"<br>("+C.getDistanceFromEvent(f)+" km) </a>",e.setAttribute("class","inactive"),a.appendChild(e)):(e=document.createElement("li"),e.innerHTML="<a href='#scrapbookView'>"+f.title+"</a>",e.onclick=t(f._id,b.showScrapbookView),c.appendChild(e),o(f)))}function o(a){var b,c=[],d=0;if(a.assetList)for(d=0;d<a.assetList.length;d++)"image"===a.assetList[d].format&&(b=new Image,b.src=a.assetList[d].uri,z.log(z.LEVEL.DEBUG,"prefetchEventResources: "+b.src),c.push(b))}function p(a,b){var c;b&&(c=document.createElement("div"),c.className="assetview",c.appendChild(q(b.format,b.uri)),a.appendChild(c))}function q(a,b){var c,d;return c=document.createElement("div"),c.setAttribute("class","highlight"),"text"===a?(d=document.createElement("p"),d.innerHTML=b):"imageURL"===a?(d=document.createElement("img"),d.src=b):"imageEmbed"===a?(d=document.createElement("div"),d.setAttribute("class","contained"),d.innerHTML=b):"video"===a?(d=document.createElement("div"),d.setAttribute("class","contained"),d.innerHTML=b):"audio"===a&&(d=document.createElement("div"),d.setAttribute("class","contained"),d.innerHTML=b),c.appendChild(d),c}function r(){z.log(z.LEVEL.ALL,"START SPINNER"),$.mobile.loading("show",{text:$.mobile.loader.prototype.options.text,textVisible:$.mobile.loader.prototype.options.textVisible,theme:$.mobile.loader.prototype.options.theme,textonly:!1,html:$.mobile.loader.prototype.options.html})}function s(){z.log(z.LEVEL.ALL,"STOP SPINNER"),$.mobile.loading("hide")}function t(a,b){var c=a;return function(){b(c)}}function u(a){if(a)for(;a.firstChild;)a.removeChild(a.firstChild)}var v,w,x,y,z=a.mhLog,A=require("src/js/pePlayerModel")(b,a),B=require("src/js/pePlayerServer")(A,a),C=require("src/js/pePlayerMapController")(b,A,a),D=!1,E=!1;return $(document).on("pagebeforeshow","#account",function(){z.log(z.LEVEL.DEBUG,"Pagebeforeshow: account"),b.viewAccountData()}),$(document).on("pagebeforeshow","#libraryView",function(){z.log(z.LEVEL.DEBUG,"Pagebeforeshow: libraryView"),b.showLibraryView()}),$(document).on("pagecreate","#libraryView",function(){z.log(z.LEVEL.DEBUG,"Pagecreate: libraryView"),document.getElementById("sbtn").onclick=b.showLibraryView,document.getElementById("keywordSearch").onkeypress=b.keywordSearch}),$(document).on("pagebeforeshow","#mainView",function(){z.log(z.LEVEL.DEBUG,"Pagebeforeshow: mainView"),b.showMainView()}),$(document).on("pagecreate","#mainView",function(){z.log(z.LEVEL.DEBUG,"Pagecreate: mainView")}),$(document).on("pagecreate","#mapViewChapters",function(){z.log(z.LEVEL.DEBUG,"Pagecreate: mapViewChapters"),document.getElementById("chaptersYourLocationButton").onclick=C.mapViewChaptersYourLocation,document.getElementById("chaptersChapterLocationButton").onclick=C.mapViewChaptersChapterLocation}),$(document).on("pagecreate","#mapViewEvents",function(){z.log(z.LEVEL.DEBUG,"Pagecreate: mapViewEvents"),document.getElementById("eventsYourLocationButton").onclick=C.mapViewEventsYourLocation,document.getElementById("eventsEventLocationButton").onclick=C.mapViewEventsEventLocation,document.getElementById("accuracyLabel").className="accuracyLabelGreen"}),b.checkIfAuthenticated=function(){B.checkAuth(function(a){a.loggedIn&&(z.log(z.LEVEL.DEBUG,"checkAuth (anonymous callback): "+a.loggedIn),b.showMainView())})},b.viewAccountData=function(){var a,b,c,d,e;a=document.getElementById("accountDisplay_fname"),a.innerHTML=v.name,b=document.getElementById("accountDisplay_peid"),b.innerHTML=v._id,v.facebook&&v.facebook.id&&v.facebook.token?(c=document.getElementById("linkFBButton"),c.href="/unlink/facebook",c.innerHTML="Unlink Facebook Account"):(c=document.getElementById("linkFBButton"),c.href="/connect/facebook",c.innerHTML="Link Facebook Account"),v.twitter&&v.twitter.id&&v.twitter.token?(d=document.getElementById("linkTWButton"),d.href="/unlink/twitter",d.innerHTML="Unlink Twitter Account"):(d=document.getElementById("linkTWButton"),d.href="/connect/twitter",d.innerHTML="Link Twitter Account"),v.google&&v.google.id&&v.google.token?(e=document.getElementById("linkGButton"),e.href="/unlink/google",e.innerHTML="Unlink Google Account"):(e=document.getElementById("linkGButton"),e.href="/connect/google",e.innerHTML="Link Google Account")},b.getAuthorData=function(){return v},b.showMainView=function(){r(),"undefined"==typeof v?(z.log(z.LEVEL.DEBUG,"showMainView:  author is undefined"),B.getAuthorData(c,d)):(z.log(z.LEVEL.DEBUG,"showMainMenu:  author is defined"),c(v),d())},b.showLibraryView=function(){var a;z.log(z.LEVEL.DEBUG,"showLibraryView:  libraryView initialization event fired"),document.getElementById("keywordSearch").value="",a=document.getElementById("keywordStories"),u(a),r(),B.getRecentStories(h)},b.keywordSearch=function(a){var b,c;13===a.keyCode&&(b=document.getElementById("keywordSearch").value,c=b.split(" ",1)[0],c.toLowerCase(),""!==c&&(r(),B.keywordSearch(c,k)))},b.showStoryOverview=function(a){z.log(z.LEVEL.DEBUG,"showStoryOverview:  Story id =  "+a),b.setCurrentStoryID(a);var c,d,e,f,g,h,i;c=A.findStoryByID(a),c?(r(),e=document.getElementById("overviewStoryTitle"),e.innerHTML=c.title,c.image?(f=document.getElementById("overviewStoryImage"),u(f),d=document.createElement("img"),d.onload=s,d.src=c.image,f.appendChild(d)):s(),g=document.getElementById("overviewStoryText"),g.innerHTML=c.overview,h=document.getElementById("overviewStoryBtn"),h.onclick=b.showChapter.bind(window,a)):(b.setCurrentStoryID(null),i=document.getElementById("errorPage"),i.innerHTML="Invalid Story, please delete story from your reading list",$.mobile.changePage($("#notFunctional")))},b.setCurrentStoryID=function(a){w=a},b.getCurrentStoryID=function(){return w},b.showChapter=function(a){var b,c,d,e=A.findStoryByID(a),f=document.getElementById("chapterViewTitle");f.innerHTML=e.title,b=document.getElementById("chapterList"),u(b),c=document.getElementById("viewedChapterList"),u(c),e.chapterList&&0!==e.chapterList.length&&(e.chapterList.map(l.bind(window,b,c)),$("#chapterList").hasClass("ui-listview")&&($("#chapterList").listview({icon:"arrow-r"}),$("#chapterList").listview("refresh")),$("#viewedChapterList").hasClass("ui-listview")&&$("#viewedChapterList").listview("refresh")),null===b.firstChild&&(z.log(z.LEVEL.DEBUG,"All done with chapters!"),d=document.createElement("li"),d.innerHTML="<a href='#mainView'><h1>Story Complete!</h1><p>Click me to go back<br>to the Main Menu</p></a>",b.appendChild(d),$("#chapterList").hasClass("ui-listview")&&($("#chapterList").listview({icon:"home"}),$("#chapterList").listview("refresh")))},b.updateChapterLocation=function(){b.showChapter(b.getCurrentStoryID()),D&&($("#newChapterNotification").popup("open",{positionTo:"window",transition:"pop"}),D=!1)},b.getChapterOpenPanelFunction=function(){return function(){$("#chaptersPanel").panel("open")}},b.getEventOpenPanelFunction=function(){return function(){$("#pagesPanel").panel("open")}},b.showChapterOverview=function(a){b.setCurrentChapterID(a);var c=A.findChapterByID(a);c.completed||(c.completed=!0,B.markChapterCompleted(c),z.log(z.LEVEL.DEBUG,"showChapterOverview: Chapter "+JSON.stringify(c)+" is done."));var d=document.getElementById("overviewChapterTitle");d.innerHTML=c.title;var e=document.getElementById("overviewChapterImage");e.innerHTML='<img src="'+c.image+'"/>';var f=document.getElementById("overviewChapterText");f.innerHTML=c.overview},b.setCurrentChapterID=function(a){x=a},b.getCurrentChapterID=function(){return x},b.showEvent=function(a){var b,c,d,e=A.findChapterByID(a),f=document.getElementById("eventViewTitle");f.innerHTML=e.title,b=document.getElementById("eventList"),u(b),c=document.getElementById("viewedEventList"),u(c),e.eventList&&0!==e.eventList.length&&(e.eventList.map(n.bind(window,b,c)),$("#eventList").hasClass("ui-listview")&&($("#eventList").listview({icon:"arrow-r"}),$("#eventList").listview("refresh")),$("#viewedEventList").hasClass("ui-listview")&&$("#viewedEventList").listview("refresh")),null===b.firstChild&&(z.log(z.LEVEL.DEBUG,"showEvent:  All pages complete."),d=document.createElement("li"),d.innerHTML="<a href='#mapViewChapters'><h1>Chapter Complete!</h1><p>Click me to go back<br>to the Chapter Menu</p></a>",b.appendChild(d),$("#eventList").hasClass("ui-listview")&&($("#eventList").listview({icon:"home"}),$("#eventList").listview("refresh")))},b.updateEventLocation=function(){b.showEvent(b.getCurrentChapterID()),E&&($("#newEventNotification").popup("open",{positionTo:"window",transition:"pop"}),E=!1)},b.updateGPSIndicator=function(a){var b=document.getElementById("accuracyLabel");b.className=50>a?"accuracyLabelGreen":200>a?"accuracyLabelYellow":"accuracyLabelRed"},b.showScrapbookView=function(a){b.setCurrentEventID(a);var c=A.findEventByID(a);c.completed||(c.completed=!0,B.markEventCompleted(c),z.log(z.LEVEL.DEBUG,"showScrapbooView: Event "+JSON.stringify(c)+" done."));var d=document.getElementById("scrapbookViewTitle");d.innerHTML=c.title;var e=document.getElementById("scrapbookViewAssets");u(e),c.assetList.sort(function(a,b){return a.order-b.order}),c.assetList.map(p.bind(window,e))},b.setCurrentEventID=function(a){y=a},b.getCurrentEventID=function(){return y},b}}(getGlobalContainer());